<div class="page-header">
    <h2><i class="fas fa-user-times"></i> Poissaolot</h2>
    <a href="/teacher/absence/add" class="btn btn-primary">
        <i class="fas fa-plus"></i>
        Lisää poissaolo
    </a>
</div>

<% if (absences && absences.length > 0) { %>
<div class="absences-container">
    <% absences.forEach(function(absence) { %>
    <div class="absence-card">
        <div class="absence-header">
            <div class="absence-student">
                <i class="fas fa-user"></i>
                <%= absence.student_name %>
            </div>
            <div class="absence-class">
                <i class="fas fa-users"></i>
                Luokka: <%= absence.class_id %>
            </div>
            <div class="absence-type type-<%= absence.type %>">
                <% if (absence.type === 'unclear') { %>
                <i class="fas fa-question-circle"></i>
                Selvittämätön
                <% } else if (absence.type === 'with_permission') { %>
                <i class="fas fa-check-circle"></i>
                Luvallinen
                <% } else { %>
                <i class="fas fa-times-circle"></i>
                Luvaton
                <% } %>
            </div>
        </div>
        
        <div class="absence-details">
            <div class="absence-lesson">
                <i class="fas fa-book"></i>
                <%= absence.subject %>
            </div>
            <div class="absence-date">
                <i class="fas fa-calendar"></i>
                <%= new Date(absence.date).toLocaleDateString('fi-FI', { weekday: 'long', day: 'numeric', month: 'long' }) %>
            </div>
            <div class="absence-time">
                <i class="fas fa-clock"></i>
                <%= absence.start_time %> - <%= absence.end_time %>
            </div>
        </div>
        
        <% if (absence.reason) { %>
        <div class="absence-reason">
            <strong>Selitys:</strong> <%= absence.reason %>
        </div>
        <% } %>
        
        <div class="absence-status">
            <% if (absence.seen_by_parent_at) { %>
            <div class="status-acknowledged">
                <i class="fas fa-check"></i>
                Kuitattu huoltajalta: <%= new Date(absence.seen_by_parent_at).toLocaleString('fi-FI') %>
            </div>
            <% } else { %>
            <div class="status-pending">
                <i class="fas fa-exclamation-triangle"></i>
                Odottaa huoltajan kuitatusta
            </div>
            <% } %>
        </div>
        
        <div class="absence-actions">
            <form method="POST" action="/teacher/absence/<%= absence.id %>/update" class="inline-form">
                <select name="type" class="form-control-sm">
                    <option value="unclear" <%= absence.type === 'unclear' ? 'selected' : '' %>>Selvittämätön</option>
                    <option value="with_permission" <%= absence.type === 'with_permission' ? 'selected' : '' %>>Luvallinen</option>
                    <option value="without_permission" <%= absence.type === 'without_permission' ? 'selected' : '' %>>Luvaton</option>
                </select>
                <input type="text" name="reason" placeholder="Selitys" value="<%= absence.reason || '' %>" class="form-control-sm">
                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="fas fa-save"></i>
                    Päivitä
                </button>
            </form>
            
            <!-- Muutettu: Poista-painike avaa modaalin varmistuksen (ei alert) -->
            <form method="POST" action="/teacher/absence/<%= absence.id %>/delete" class="inline-form delete-form" data-absence-id="<%= absence.id %>">
                <button type="button" class="btn btn-sm btn-danger btn-delete" data-absence-id="<%= absence.id %>">
                    <i class="fas fa-trash"></i>
                    Poista
                </button>
            </form>
        </div>
    </div>
    <% }); %>
</div>
<% } else { %>
<div class="no-data">
    <i class="fas fa-user-times"></i>
    <h3>Ei poissaoloja</h3>
    <p>Poissaoloja ei ole vielä rekisteröity.</p>
</div>
<% } %>

<div class="page-actions">
    <a href="/teacher/dashboard" class="btn btn-outline">
        <i class="fas fa-arrow-left"></i>
        Takaisin etusivulle
    </a>
</div>

<style>

#confirm-delete-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 2000; }
#confirm-delete-modal[aria-hidden="false"] { display: flex; }
#confirm-delete-modal .modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.5); }
#confirm-delete-modal .modal-dialog { position: relative; background: #fff; padding: 1.25rem; border-radius: 6px; max-width: 420px; width: 90%; box-shadow: 0 6px 18px rgba(0,0,0,0.2); z-index: 2010; }
#confirm-delete-modal .modal-actions { margin-top: 1rem; text-align: right; }
#confirm-delete-modal .modal-actions .btn { margin-left: 0.5rem; }
</style>

<div id="confirm-delete-modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="confirm-delete-title">
    <div class="modal-backdrop" tabindex="-1"></div>
    <div class="modal-dialog" role="document" aria-describedby="confirm-delete-desc">
        <h3 id="confirm-delete-title">Poista poissaolo</h3>
        <p id="confirm-delete-desc">Haluatko varmasti poistaa tämän poissaolon?</p>
        <div class="modal-actions">
            <button id="confirm-delete-no" class="btn btn-outline" type="button">Ei</button>
            <button id="confirm-delete-yes" class="btn btn-danger" type="button">Kyllä</button>
        </div>
    </div>
</div>

<script>
(function(){
    var modal = document.getElementById('confirm-delete-modal');
    var yesBtn = document.getElementById('confirm-delete-yes');
    var noBtn = document.getElementById('confirm-delete-no');
    var currentForm = null;

    document.addEventListener('click', function(e){
        var delBtn = e.target.closest('.btn-delete');
        if (!delBtn) return;
        e.preventDefault();
        currentForm = delBtn.closest('form.delete-form');

        modal.setAttribute('aria-hidden', 'false');

        yesBtn.focus();
    });

    function hideModal(){
        modal.setAttribute('aria-hidden', 'true');
        currentForm = null;
    }

    yesBtn.addEventListener('click', function(){
        if (currentForm) currentForm.submit();
        hideModal();
    });

    noBtn.addEventListener('click', function(){
        hideModal();
    });


    modal.addEventListener('click', function(e){
        if (e.target.classList.contains('modal-backdrop')) hideModal();
    });
    document.addEventListener('keydown', function(e){
        if (e.key === 'Escape') hideModal();
    });
})();
</script>
